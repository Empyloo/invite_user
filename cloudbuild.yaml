steps:
  # Deploy the cloud function
  - name: gcr.io/cloud-builders/gcloud
    env:
      - 'SUPABASE_URL=${_SUPABASE_URL}'
      - 'SERVICE_ROLE_KEY=${_SERVICE_ROLE_KEY}'
    args:
      - gcloud
      - functions
      - deploy
      - invite-user-function
      - --gen2
      - --runtime=python310
      - --region=europe-west2
      - --source=.
      - --entry-point=main
      - --trigger-http
      - --memory=256MiB
      - --service-account=${_SERVICE_ACCOUNT}
      - --no-allow-unauthenticated
      - --set-env-vars=SUPABASE_URL=${_SUPABASE_URL}
      - --set-env-vars=SERVICE_ROLE_KEY=${_SERVICE_ROLE_KEY}
      - --set-env-vars=SERVICE_ACCOUNT=${_SERVICE_ACCOUNT}

  # Retrieve the function URL
  - name: gcr.io/cloud-builders/gcloud
    args: ['functions', 'describe', 'invite-user-function', '--format', 'value(httpsTrigger.url)']
    id: get-function-url
    env:
      - 'FUNCTION_URL=$(gsutil cat gs://$_OUTPUT_BUCKET/build-log.txt)'
    waitFor: ['deploy-function']

  # Create or update the task queue
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: deploy-queue
    waitFor: ['get-function-url']
    entrypoint: 'bash'
    args:
      - -c
      - echo $FUNCTION_URL
